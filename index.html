<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizador de Precios Procoquim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .progress-step {
            position: relative;
        }
        
        .progress-step::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 100px;
            height: 2px;
            background: #e5e7eb;
            transform: translateY(-50%);
            z-index: -1;
        }
        
        .progress-step:last-child::before {
            display: none;
        }
        
        .progress-step.completed::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .file-drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: #667eea;
            background-color: #f8fafc;
            transform: scale(1.02);
        }
        
        .success-checkmark {
            animation: checkmark 0.6s ease-in-out;
        }
        
        @keyframes checkmark {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .icon-bounce {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(0);
            }
            40%, 43% {
                transform: translateY(-10px);
            }
            70% {
                transform: translateY(-5px);
            }
            90% {
                transform: translateY(-2px);
            }
        }
        
        .table-row-hover {
            transition: all 0.2s ease;
        }
        
        .table-row-hover:hover {
            background: linear-gradient(90deg, #f0f9ff, #e0f2fe);
            transform: scale(1.01);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .button-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .button-gradient:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .section-fade {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s ease;
        }
        
        .section-fade.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
    <!-- Header con gradiente -->
    <div class="gradient-bg text-white py-8">
        <div class="max-w-7xl mx-auto px-6">
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-pulse">
                    üß™ Actualizador de Precios Procoquim
                </h1>
                <p class="text-xl opacity-90 max-w-3xl mx-auto">
                    Transforma facturas de Procoquim en actualizaciones autom√°ticas de inventario con tecnolog√≠a inteligente
                </p>
                <div class="mt-6 flex justify-center space-x-4">
                    <span class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm">‚ö° Procesamiento Autom√°tico</span>
                    <span class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm">üéØ Coincidencias Inteligentes</span>
                    <span class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm">üìä Exportaci√≥n Excel</span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 -mt-4">
        <!-- Indicadores de progreso mejorados -->
        <div class="mb-12">
            <div class="bg-white rounded-2xl shadow-2xl p-8 glass-effect">
                <h2 class="text-2xl font-semibold text-center mb-8 text-gray-800">Progreso del Proceso</h2>
                <div class="flex items-center justify-center space-x-8">
                    <div class="progress-step flex flex-col items-center" id="step1">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-lg font-bold bg-gray-100 text-gray-400 transition-all duration-500">
                            üìÑ
                        </div>
                        <span class="mt-3 text-sm font-medium text-gray-400">Cargar Factura</span>
                        <div class="mt-1 w-2 h-2 rounded-full bg-gray-300 transition-all duration-500"></div>
                    </div>
                    <div class="progress-step flex flex-col items-center" id="step2">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-lg font-bold bg-gray-100 text-gray-400 transition-all duration-500">
                            üìä
                        </div>
                        <span class="mt-3 text-sm font-medium text-gray-400">Cargar Excel</span>
                        <div class="mt-1 w-2 h-2 rounded-full bg-gray-300 transition-all duration-500"></div>
                    </div>
                    <div class="progress-step flex flex-col items-center" id="step3">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-lg font-bold bg-gray-100 text-gray-400 transition-all duration-500">
                            üîÑ
                        </div>
                        <span class="mt-3 text-sm font-medium text-gray-400">Procesar</span>
                        <div class="mt-1 w-2 h-2 rounded-full bg-gray-300 transition-all duration-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secciones de carga con dise√±o mejorado -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Carga de factura -->
            <div class="section-fade">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover file-drop-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-3xl text-white icon-bounce">
                            üìÑ
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">1. Cargar Factura PDF</h3>
                        <p class="text-gray-600 mb-6">Arrastra tu factura aqu√≠ o selecciona el archivo</p>
                        
                        <div class="mb-6">
                            <label class="cursor-pointer button-gradient text-white px-6 py-3 rounded-xl font-semibold inline-block">
                                üì§ Subir PDF de Factura
                                <input type="file" class="hidden" accept=".pdf,.txt" onchange="handleFileUpload(event)">
                            </label>
                        </div>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">o pega el texto</span>
                            </div>
                        </div>
                        
                        <textarea
                            class="w-full h-32 p-4 mt-4 border-2 border-gray-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
                            placeholder="Pega aqu√≠ el texto de la factura..."
                            onchange="handleTextPaste(event)"
                            id="textInput">
                        </textarea>
                        
                        <div id="invoiceStatus" class="mt-4 hidden">
                            <div class="flex items-center justify-center text-green-600 bg-green-50 rounded-xl p-4">
                                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3 success-checkmark">‚úì</div>
                                <span class="font-semibold">Factura procesada exitosamente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carga de Excel -->
            <div class="section-fade">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover file-drop-zone" ondrop="handleExcelDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-3xl text-white icon-bounce">
                            üìä
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">2. Cargar Excel de Inventario</h3>
                        <p class="text-gray-600 mb-6">Sube tu archivo Excel con el inventario de productos qu√≠micos</p>
                        
                        <div class="mb-6">
                            <label class="cursor-pointer bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-semibold inline-block hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105">
                                üìà Subir Excel (.xlsx)
                                <input type="file" class="hidden" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                            </label>
                        </div>
                        
                        <div class="bg-blue-50 rounded-xl p-4">
                            <p class="text-sm text-blue-700">
                                üí° <strong>Tip:</strong> Aseg√∫rate de que tu Excel tenga las columnas "üõçÔ∏è PRODUCTOS" y "üí∞ PRECIO BASE"
                            </p>
                        </div>
                        
                        <div id="excelStatus" class="mt-4 hidden">
                            <div class="flex items-center justify-center text-green-600 bg-green-50 rounded-xl p-4">
                                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3 success-checkmark">‚úì</div>
                                <span class="font-semibold">Excel cargado exitosamente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de actualizaci√≥n mejorado -->
        <div class="mb-12 text-center section-fade" id="updateSection" style="display: none;">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">¬øListo para la magia? ‚ú®</h3>
                <p class="text-gray-600 mb-6">Procesaremos tu factura y actualizaremos autom√°ticamente los precios en tu inventario</p>
                <button onclick="updateExcelPrices()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    üöÄ Actualizar Precios Autom√°ticamente
                </button>
            </div>
        </div>

        <!-- Loading mejorado -->
        <div id="loading" class="flex flex-col items-center justify-center py-16" style="display: none;">
            <div class="spinner mb-4"></div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Procesando tu informaci√≥n...</h3>
            <p class="text-gray-500 text-center max-w-md">
                Nuestros algoritmos est√°n analizando la factura y buscando coincidencias inteligentes en tu inventario
            </p>
            <div class="mt-4 w-64 bg-gray-200 rounded-full h-2">
                <div class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Error display mejorado -->
        <div id="error" class="mb-8" style="display: none;">
            <div class="bg-red-50 border-l-4 border-red-400 p-6 rounded-xl shadow-lg slide-in">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                            <span class="text-red-600 font-bold">!</span>
                        </div>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-semibold text-red-800">Oops! Algo sali√≥ mal</h3>
                        <p class="text-red-700" id="errorMessage"></p>
                    </div>
                    <button onclick="hideError()" class="ml-auto text-red-400 hover:text-red-600">
                        <span class="sr-only">Cerrar</span>
                        ‚úï
                    </button>
                </div>
            </div>
        </div>

        <!-- Resultados y detalles -->
        <div id="results" style="display: none;" class="section-fade"></div>
        <div id="invoiceDetails" style="display: none;" class="section-fade"></div>
    </div>

    <!-- Floating action button -->
    <div class="floating-action" id="floatingAction" style="display: none;">
        <button onclick="downloadUpdatedExcel()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-110">
            <span class="text-2xl">üì•</span>
        </div>
    </div>

    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Variables globales
        let invoiceData = null;
        let excelData = null;
        let updateResults = null;

        // Intersection Observer para animaciones
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        // Observar elementos con animaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.section-fade').forEach(el => {
                observer.observe(el);
            });
        });

        // Mapeo de productos
        const productMapping = {
            'ACIDO ACETICO': 'ACIDO ACETICO TECNICO',
            'ACIDO NITRICO': 'ACIDO NITRICO',
            'ACIDO SULFONICO': 'ACIDO SULFONICO',
            'ACIDO OXALICO': 'ACIDO OXALICO',
            'ACIDO CITRICO': 'ACIDO CITRICO',
            'ALCOHOL CETILICO': 'CETOL C 16 - ALCOHOL CETILICO',
            'CETOL C 16': 'CETOL C 16 - ALCOHOL CETILICO',
            'ALCOHOL ETILICO': 'ALCOHOL ETANOL IND.',
            'ALCOHOL DESODORIZADO': 'ALCOHOL ETANOL IND.',
            'ALCOHOL PROPANOL': 'ALCOHOL PROPANOL',
            'VARSOL': 'VARSOL',
            'BETAINA': 'BETAINA',
            'COCOAMIDA': 'COCOAMIDA',
            'DODIGEN': 'DODIGEN',
            'GENAPOL': 'LESS AL 70% - LAURIL √âTER SULFATO DE SODIO',
            'LESS AL 70%': 'LESS AL 70% - LAURIL √âTER SULFATO DE SODIO',
            'NONIL': 'TERGICOL - NONIL',
            'BUTIL GLICOL': 'MONOBUTIL ETER - BUTIL GLICOL',
            'FORMOL': 'FORMOL',
            'GLICERINA': 'GLICERINA',
            'BICARBONATO DE SODIO': 'BICARBONATO DE SODIO USP',
            'BICARBONATO DE SODIO USP': 'BICARBONATO DE SODIO USP',
            'BISULFITO DE SODIO': 'BISULFITO EN POLVO',
            'SODA': 'SODA CAUSTICA',
            'SODA CAUSTICA': 'SODA CAUSTICA',
            'TPF': 'TRIPOLIFOSFATO',
            'TRIPOLIFOSFATO': 'TRIPOLIFOSFATO',
            'SILICONA EMULSION': 'SILICONA EMULSION',
            'CREOLINA': 'CREOLINA CONCENTRADA',
            'HIPOCLORITO DE SODIO': 'HIPOCLORITO DE SODIO AL 13%',
            'HIPOCLORITO DE SODIO AL 13%': 'HIPOCLORITO DE SODIO AL 13%',
            'HIPOCLORITO DE SODIO AL 15%': 'HIPOCLORITO DE SODIO AL 13%',
            'PROCIDE': 'PROCIDE 1.5',
            'PROCIDE 1.5': 'PROCIDE 1.5',
            'RINSOL': 'RINSOL',
            'SUAVIZANTE': 'SENSASOFT - SUAVIZANTE ENCAPSULADO BRISA FRESCA',
            'SENSASOFT': 'SENSASOFT - SUAVIZANTE ENCAPSULADO BRISA FRESCA',
            'SENSACLEAN': 'SENSACLEAN - DETERGENTE LIQUIDO',
            'SENSABLEACH': 'SENSABLEACH - BLANQUEADOR OXIGENADO'
        };

        // Funciones de utilidad mejoradas
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            simulateProgress();
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function simulateProgress() {
            const progressBar = document.querySelector('.progress-bar');
            let width = 0;
            const interval = setInterval(() => {
                width += Math.random() * 15;
                if (width >= 100) {
                    width = 100;
                    clearInterval(interval);
                }
                progressBar.style.width = width + '%';
            }, 200);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').style.display = 'block';
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideError();
            }, 10000);
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification p-4 rounded-xl shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white font-semibold`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function updateStepStatus(step, completed) {
            const stepElement = document.getElementById(`step${step}`);
            const circle = stepElement.querySelector('div');
            const dot = stepElement.querySelector('.w-2');
            
            if (completed) {
                stepElement.className = 'progress-step completed flex flex-col items-center';
                circle.className = 'w-16 h-16 rounded-full flex items-center justify-center text-lg font-bold bg-gradient-to-br from-green-400 to-green-600 text-white transition-all duration-500 transform scale-110';
                stepElement.querySelector('span').className = 'mt-3 text-sm font-medium text-green-600';
                dot.className = 'mt-1 w-2 h-2 rounded-full bg-green-500 transition-all duration-500';
                
                // A√±adir efecto de √©xito
                circle.style.animation = 'checkmark 0.6s ease-in-out';
            }
        }

        function formatCurrency(value) {
            return value ? new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP' 
            }).format(value) : 'N/A';
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const event = { target: { files: [files[0]] } };
                handleFileUpload(event);
            }
        }

        function handleExcelDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const event = { target: { files: [files[0]] } };
                handleExcelUpload(event);
            }
        }

        function isPackagingItem(productName) {
            const packagingKeywords = ['TAMBOR', 'TANQUE', 'BID√ìN', 'BALDE', 'CANECA', 'ENVASE', 'RECIPIENTE', 'GAL√ìN', 'PIMPINA', 'IBC', 'CONTENEDOR'];
            const normalizedName = productName.toUpperCase();
            return packagingKeywords.some(keyword => normalizedName.includes(keyword));
        }

        function normalizeProductName(productName) {
            const normalized = productName.toUpperCase().trim();
            if (productMapping[normalized]) {
                return productMapping[normalized];
            }
            for (const [key, value] of Object.entries(productMapping)) {
                if (normalized.includes(key) || key.includes(normalized)) {
                    return value;
                }
            }
            return productName;
        }

        function extractBaseName(productName) {
            let baseName = productName.toUpperCase().trim();
            
            const presentationPatterns = [
                /\s*X\s*\d+(\.\d+)?\s*(KG|KILOGRAMO|KILOGRAMOS|G|GRAMO|GRAMOS|L|LITRO|LITROS|ML|MILILITRO|MILILITROS|GAL|GAL√ìN|GALONES)/gi,
                /\s*X\s*\d+\/\d+\s*(KG|KILOGRAMO|KILOGRAMOS|G|GRAMO|GRAMOS|L|LITRO|LITROS|ML|MILILITRO|MILILITROS)/gi,
                /\s*\d+(\.\d+)?\s*(KG|KILOGRAMO|KILOGRAMOS|G|GRAMO|GRAMOS|L|LITRO|LITROS|ML|MILILITRO|MILILITROS|GAL|GAL√ìN|GALONES)$/gi
            ];
            
            presentationPatterns.forEach(pattern => {
                baseName = baseName.replace(pattern, '');
            });
            
            baseName = baseName.replace(/\s+/g, ' ').trim();
            baseName = baseName.replace(/[-\s]*$/, '');
            
            return baseName;
        }

        function normalizeForComparison(name) {
            let normalized = extractBaseName(name);
            const commonWords = ['TECNICO', 'TEC', 'IND', 'INDUSTRIAL', 'USP', 'CONCENTRADA', 'CONCENTRADO', 'AL', 'DE', 'EN', 'POLVO'];
            commonWords.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                normalized = normalized.replace(regex, '');
            });
            return normalized.replace(/\s+/g, ' ').trim();
        }

        // Extraer texto de PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }

            return fullText;
        }

        // Parsear texto de factura
        function parseInvoiceText(text) {
            try {
                const invoiceNumberMatch = text.match(/No\.\s*PCQP\s*(\d+)/);
                const invoiceNumber = invoiceNumberMatch ? invoiceNumberMatch[1] : null;

                const generationDateMatch = text.match(/Generaci√≥n\s*(\d{2}\/\d{2}\/\d{4})/);
                const expeditionDateMatch = text.match(/Expedici√≥n\s*(\d{2}\/\d{2}\/\d{4})/);
                const dueDateMatch = text.match(/Vencimiento\s*(\d{2}\/\d{2}\/\d{4})/);

                const customerMatch = text.match(/Se√±ores\s*([A-Z√Å√â√ç√ì√ö√ë\s]+)/);
                const nitMatch = text.match(/NIT\s*([\d\.-]+)/);

                const totalBrutoMatch = text.match(/Total Bruto\s*([\d,]+\.?\d*)/);
                const ivaMatch = text.match(/IVA 19%\s*([\d,]+\.?\d*)/);
                const totalPagarMatch = text.match(/Total a Pagar\s*([\d,]+\.?\d*)/);

                const products = [];
                const productRegex = /(\d+)\s+([A-Z√Å√â√ç√ì√ö√ë\s\-\d%.X]+?)\s+(Kilogramo|Kilogramos|Litro|LITROS|kilogramo|Unidad)\s+(\d+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+\d+\s*%\s+([\d,]+\.?\d*)/gm;
                
                let match;
                while ((match = productRegex.exec(text)) !== null) {
                    const originalProductName = match[2].trim();
                    const normalizedProductName = normalizeProductName(originalProductName);
                    const isPackaging = isPackagingItem(originalProductName);
                    const isHypochloriteCorrected = originalProductName.includes('HIPOCLORITO DE SODIO AL 15%');
                    
                    products.push({
                        item: match[1],
                        descripcionOriginal: originalProductName,
                        descripcionNormalizada: normalizedProductName,
                        unidad: match[3],
                        cantidad: parseFloat(match[4]),
                        valorUnitario: parseFloat(match[5].replace(/,/g, '')),
                        valorBruto: parseFloat(match[6].replace(/,/g, '')),
                        valorTotal: parseFloat(match[7].replace(/,/g, '')),
                        esEnvase: isPackaging,
                        errorEscritura: isHypochloriteCorrected
                    });
                }

                return {
                    proveedor: "PROCOQUIM S.A.S",
                    numeroFactura: invoiceNumber,
                    fechaGeneracion: generationDateMatch ? generationDateMatch[1] : null,
                    fechaExpedicion: expeditionDateMatch ? expeditionDateMatch[1] : null,
                    fechaVencimiento: dueDateMatch ? dueDateMatch[1] : null,
                    cliente: {
                        nombre: customerMatch ? customerMatch[1].trim() : null,
                        nit: nitMatch ? nitMatch[1] : null
                    },
                    productos: products,
                    totales: {
                        bruto: totalBrutoMatch ? parseFloat(totalBrutoMatch[1].replace(/,/g, '')) : null,
                        iva: ivaMatch ? parseFloat(ivaMatch[1].replace(/,/g, '')) : null,
                        total: totalPagarMatch ? parseFloat(totalPagarMatch[1].replace(/,/g, '')) : null
                    },
                    totalProductos: products.length
                };
            } catch (err) {
                throw new Error(`Error parsing invoice: ${err.message}`);
            }
        }

        // Manejar carga de factura
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            hideError();

            try {
                let text = '';
                
                if (file.type === 'application/pdf') {
                    text = await extractTextFromPDF(file);
                } else if (file.type === 'text/plain') {
                    text = await file.text();
                } else {
                    throw new Error('Tipo de archivo no soportado. Solo se aceptan archivos PDF y TXT.');
                }

                if (text.trim().length < 50) {
                    throw new Error('El archivo parece estar vac√≠o o no contiene suficiente texto.');
                }

                const parsedData = parseInvoiceText(text);
                invoiceData = parsedData;
                
                updateStepStatus(1, true);
                document.getElementById('invoiceStatus').classList.remove('hidden');
                displayInvoiceDetails();
                checkUpdateButton();
                showNotification('¬°Factura procesada exitosamente! üéâ');
                
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        // Manejar texto pegado
        function handleTextPaste(event) {
            const text = event.target.value;
            if (text.trim().length > 100) {
                try {
                    const parsedData = parseInvoiceText(text);
                    invoiceData = parsedData;
                    
                    updateStepStatus(1, true);
                    document.getElementById('invoiceStatus').classList.remove('hidden');
                    displayInvoiceDetails();
                    checkUpdateButton();
                    hideError();
                    showNotification('¬°Texto de factura procesado! üìÑ');
                } catch (err) {
                    showError(err.message);
                }
            }
        }

        // Manejar carga de Excel
        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            hideError();

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true
                });

                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                excelData = {
                    workbook,
                    worksheet,
                    data: jsonData,
                    sheetName: firstSheetName
                };

                updateStepStatus(2, true);
                document.getElementById('excelStatus').classList.remove('hidden');
                checkUpdateButton();
                showNotification('¬°Excel cargado correctamente! üìä');

            } catch (err) {
                showError('Error al leer el archivo Excel: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function checkUpdateButton() {
            if (invoiceData && excelData && !updateResults) {
                document.getElementById('updateSection').style.display = 'block';
                // Scroll suave al bot√≥n
                setTimeout(() => {
                    document.getElementById('updateSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 300);
            }
        }

        // Buscar coincidencias
        function findMatches(invoiceProducts, excelProducts) {
            const matches = [];
            const unmatched = [];

            invoiceProducts.forEach(invoiceProduct => {
                if (invoiceProduct.esEnvase) return;

                let bestMatch = null;
                let bestScore = 0;

                excelProducts.forEach(excelProduct => {
                    const excelName = excelProduct['üõçÔ∏è PRODUCTOS'] || '';
                    const excelBaseName = normalizeForComparison(excelName);
                    const invoiceBaseName = normalizeForComparison(invoiceProduct.descripcionNormalizada);
                    
                    let score = 0;
                    
                    if (excelBaseName === invoiceBaseName) {
                        score = 100;
                    } else if (excelBaseName.includes(invoiceBaseName) || invoiceBaseName.includes(excelBaseName)) {
                        score = 95;
                    } else {
                        const excelWords = excelBaseName.split(/\s+/).filter(word => word.length > 2);
                        const invoiceWords = invoiceBaseName.split(/\s+/).filter(word => word.length > 2);
                        
                        if (excelWords.length > 0 && invoiceWords.length > 0) {
                            const commonWords = excelWords.filter(excelWord => 
                                invoiceWords.some(invoiceWord => 
                                    excelWord.includes(invoiceWord) || invoiceWord.includes(excelWord)
                                )
                            );
                            score = (commonWords.length / Math.max(excelWords.length, invoiceWords.length)) * 90;
                        }
                    }

                    if (score > bestScore && score > 75) {
                        bestScore = score;
                        bestMatch = {
                            excelProduct,
                            excelName,
                            excelBaseName,
                            invoiceBaseName,
                            score
                        };
                    }
                });

                if (bestMatch) {
                    matches.push({
                        invoiceProduct,
                        excelMatch: bestMatch,
                        priceChange: {
                            oldPrice: bestMatch.excelProduct['üí∞ PRECIO BASE'] || 0,
                            newPrice: invoiceProduct.valorUnitario,
                            difference: invoiceProduct.valorUnitario - (bestMatch.excelProduct['üí∞ PRECIO BASE'] || 0)
                        }
                    });
                } else {
                    unmatched.push(invoiceProduct);
                }
            });

            return { matches, unmatched };
        }

        // Actualizar precios en Excel
        function updateExcelPrices() {
            if (!invoiceData || !excelData) return;

            showLoading();

            try {
                const chemicalProducts = invoiceData.productos.filter(p => !p.esEnvase);
                const { matches, unmatched } = findMatches(chemicalProducts, excelData.data);

                const newWorkbook = { ...excelData.workbook };
                const newWorksheet = { ...excelData.worksheet };

                matches.forEach(match => {
                    const excelRowIndex = excelData.data.findIndex(row => 
                        row['üõçÔ∏è PRODUCTOS'] === match.excelMatch.excelName
                    ) + 2;

                    const cellAddress = `B${excelRowIndex}`;
                    if (!newWorksheet[cellAddress]) {
                        newWorksheet[cellAddress] = {};
                    }
                    newWorksheet[cellAddress].v = match.invoiceProduct.valorUnitario;
                    newWorksheet[cellAddress].t = 'n';
                });

                updateResults = {
                    matches,
                    unmatched,
                    updatedWorkbook: newWorkbook,
                    updatedWorksheet: newWorksheet
                };

                updateStepStatus(3, true);
                displayResults();
                document.getElementById('floatingAction').style.display = 'block';
                showNotification('¬°Precios actualizados exitosamente! üöÄ');

            } catch (err) {
                showError('Error al actualizar precios: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // Descargar Excel actualizado
        function downloadUpdatedExcel() {
            if (!updateResults) return;

            try {
                const wb = updateResults.updatedWorkbook;
                wb.Sheets[excelData.sheetName] = updateResults.updatedWorksheet;
                
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Inventario_Actualizado_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('¬°Archivo descargado exitosamente! üì•');
            } catch (err) {
                showError('Error al generar el archivo Excel: ' + err.message);
            }
        }

        // Mostrar detalles de la factura
        function displayInvoiceDetails() {
            if (!invoiceData) return;

            const chemicalProducts = invoiceData.productos.filter(p => !p.esEnvase);
            const packagingProducts = invoiceData.productos.filter(p => p.esEnvase);
            const errorProducts = invoiceData.productos.filter(p => p.errorEscritura);

            const html = `
                <div class="space-y-8 fade-in">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-3xl shadow-2xl overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-8">
                            <h2 class="text-3xl font-bold mb-2 flex items-center">
                                <span class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">‚úÖ</span>
                                Factura Procesada Exitosamente
                            </h2>
                            <p class="text-blue-100">Todos los datos han sido extra√≠dos y organizados autom√°ticamente</p>
                        </div>

                        <div class="p-8 space-y-6">
                            <!-- Informaci√≥n general con dise√±o de tarjetas -->
                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                                    <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">üìã</span>
                                    Informaci√≥n General
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="stat-card p-6">
                                        <div class="flex items-center mb-2">
                                            <span class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center mr-3 text-sm">üìÑ</span>
                                            <label class="text-sm font-semibold text-gray-600">N√∫mero de Factura</label>
                                        </div>
                                        <p class="text-xl font-bold text-blue-600">PCQP ${invoiceData.numeroFactura || 'N/A'}</p>
                                    </div>
                                    <div class="stat-card p-6">
                                        <div class="flex items-center mb-2">
                                            <span class="w-8 h-8 bg-green-500 text-white rounded-lg flex items-center justify-center mr-3 text-sm">üìÖ</span>
                                            <label class="text-sm font-semibold text-gray-600">Fecha de Generaci√≥n</label>
                                        </div>
                                        <p class="text-xl font-bold text-green-600">${invoiceData.fechaGeneracion || 'N/A'}</p>
                                    </div>
                                    <div class="stat-card p-6">
                                        <div class="flex items-center mb-2">
                                            <span class="w-8 h-8 bg-purple-500 text-white rounded-lg flex items-center justify-center mr-3 text-sm">üè¢</span>
                                            <label class="text-sm font-semibold text-gray-600">Cliente</label>
                                        </div>
                                        <p class="text-lg font-bold text-purple-600">${invoiceData.cliente.nombre || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen de productos con estad√≠sticas visuales -->
                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                                    <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">üìä</span>
                                    Resumen de Productos
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    <div class="text-center stat-card p-6">
                                        <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4">
                                            üì¶
                                        </div>
                                        <div class="text-3xl font-bold text-blue-600 mb-2">${invoiceData.totalProductos}</div>
                                        <div class="text-sm font-medium text-gray-600">Total productos</div>
                                    </div>
                                    <div class="text-center stat-card p-6">
                                        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4">
                                            üß™
                                        </div>
                                        <div class="text-3xl font-bold text-green-600 mb-2">${chemicalProducts.length}</div>
                                        <div class="text-sm font-medium text-gray-600">Productos qu√≠micos</div>
                                    </div>
                                    <div class="text-center stat-card p-6">
                                        <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-purple-600 rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4">
                                            üì¶
                                        </div>
                                        <div class="text-3xl font-bold text-purple-600 mb-2">${packagingProducts.length}</div>
                                        <div class="text-sm font-medium text-gray-600">Items de envase</div>
                                    </div>
                                    <div class="text-center stat-card p-6">
                                        <div class="w-16 h-16 bg-gradient-to-br from-orange-400 to-orange-600 rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4">
                                            ‚ö†Ô∏è
                                        </div>
                                        <div class="text-3xl font-bold text-orange-600 mb-2">${errorProducts.length}</div>
                                        <div class="text-sm font-medium text-gray-600">Errores corregidos</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabla de productos qu√≠micos mejorada -->
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white p-6">
                                    <h3 class="text-xl font-bold flex items-center">
                                        <span class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">üß™</span>
                                        Productos Qu√≠micos para Inventario (${chemicalProducts.length})
                                    </h3>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Item</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Producto</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Cantidad</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Valor Unitario</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            ${chemicalProducts.map((producto, index) => `
                                                <tr class="table-row-hover ${producto.errorEscritura ? 'bg-orange-50' : ''}">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-sm mr-3">
                                                                ${producto.item}
                                                            </div>
                                                            ${producto.errorEscritura ? '<span class="px-3 py-1 text-xs bg-orange-100 text-orange-700 rounded-full font-semibold">Corregido ‚úì</span>' : ''}
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="space-y-1">
                                                            <div class="font-semibold text-gray-900">${producto.descripcionOriginal}</div>
                                                            <div class="text-sm text-blue-600 bg-blue-50 rounded-lg px-3 py-1 inline-block">
                                                                ${producto.descripcionNormalizada}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="px-3 py-2 bg-gray-100 rounded-lg font-semibold text-gray-800">
                                                            ${producto.cantidad} ${producto.unidad}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-lg font-bold text-green-600">
                                                            ${formatCurrency(producto.valorUnitario)}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-lg font-bold text-blue-600">
                                                            ${formatCurrency(producto.valorTotal)}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            ${packagingProducts.length > 0 ? `
                            <!-- Items de envase con dise√±o mejorado -->
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6">
                                    <h3 class="text-xl font-bold flex items-center">
                                        <span class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">üì¶</span>
                                        Items de Envase (${packagingProducts.length})
                                    </h3>
                                    <p class="text-purple-100 mt-2">Estos items no afectar√°n el inventario qu√≠mico</p>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${packagingProducts.map((producto, index) => `
                                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-4 card-hover">
                                                <div class="flex items-start space-x-3">
                                                    <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white font-bold">
                                                        üì¶
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="font-semibold text-gray-900 mb-1">${producto.descripcionOriginal}</div>
                                                        <div class="text-sm text-gray-600 mb-2">
                                                            ${producto.cantidad} ${producto.unidad}
                                                        </div>
                                                        <div class="text-lg font-bold text-purple-600">
                                                            ${formatCurrency(producto.valorUnitario)}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('invoiceDetails').innerHTML = html;
            document.getElementById('invoiceDetails').style.display = 'block';
            
            // Animar la aparici√≥n
            setTimeout(() => {
                document.getElementById('invoiceDetails').classList.add('visible');
            }, 100);
        }

        // Mostrar resultados de actualizaci√≥n con dise√±o mejorado
        function displayResults() {
            if (!updateResults) return;

            const totalDifference = updateResults.matches.reduce((total, match) => total + Math.abs(match.priceChange.difference), 0);

            const html = `
                <div class="space-y-8 fade-in">
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-3xl shadow-2xl overflow-hidden">
                        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-8">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-3xl font-bold mb-2 flex items-center">
                                        <span class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4 text-2xl">üéâ</span>
                                        ¬°Actualizaci√≥n Completada!
                                    </h2>
                                    <p class="text-green-100">Tu inventario ha sido actualizado con los nuevos precios</p>
                                </div>
                                <button
                                    onclick="downloadUpdatedExcel()"
                                    class="bg-white text-green-600 px-6 py-3 rounded-2xl font-bold hover:bg-green-50 transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center">
                                    <span class="text-xl mr-2">üì•</span>
                                    Descargar Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-8">
                            <!-- Estad√≠sticas principales -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="text-center stat-card p-8">
                                    <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center text-white text-3xl mx-auto mb-4">
                                        ‚úÖ
                                    </div>
                                    <div class="text-4xl font-bold text-green-600 mb-2">${updateResults.matches.length}</div>
                                    <div class="text-lg font-semibold text-gray-700">Productos Actualizados</div>
                                    <div class="text-sm text-gray-500 mt-1">Precios sincronizados exitosamente</div>
                                </div>
                                <div class="text-center stat-card p-8">
                                    <div class="w-20 h-20 bg-gradient-to-br from-orange-400 to-orange-600 rounded-3xl flex items-center justify-center text-white text-3xl mx-auto mb-4">
                                        ‚ö†Ô∏è
                                    </div>
                                    <div class="text-4xl font-bold text-orange-600 mb-2">${updateResults.unmatched.length}</div>
                                    <div class="text-lg font-semibold text-gray-700">Sin Coincidencia</div>
                                    <div class="text-sm text-gray-500 mt-1">Requieren revisi√≥n manual</div>
                                </div>
                                <div class="text-center stat-card p-8">
                                    <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-blue-600 rounded-3xl flex items-center justify-center text-white text-3xl mx-auto mb-4">
                                        üí∞
                                    </div>
                                    <div class="text-3xl font-bold text-blue-600 mb-2">
                                        ${totalDifference.toLocaleString('es-CO')}
                                    </div>
                                    <div class="text-lg font-semibold text-gray-700">Diferencia Total</div>
                                    <div class="text-sm text-gray-500 mt-1">Cambio en valorizaci√≥n</div>
                                </div>
                            </div>

                            ${updateResults.matches.length > 0 ? `
                            <!-- Tabla de coincidencias con dise√±o premium -->
                            <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
                                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white p-6">
                                    <h3 class="text-2xl font-bold flex items-center">
                                        <span class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4">‚úÖ</span>
                                        Productos Actualizados (${updateResults.matches.length})
                                    </h3>
                                    <p class="text-blue-100 mt-2">Estos productos han sido actualizados autom√°ticamente en tu inventario</p>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Producto en Excel</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Producto en Factura</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Precio Anterior</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Precio Nuevo</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Diferencia</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Coincidencia</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            ${updateResults.matches.map((match, index) => `
                                                <tr class="table-row-hover">
                                                    <td class="px-6 py-4">
                                                        <div class="space-y-1">
                                                            <div class="font-semibold text-gray-900">${match.excelMatch.excelName}</div>
                                                            <div class="text-xs text-blue-600 bg-blue-50 rounded-lg px-2 py-1 inline-block">
                                                                Base: ${match.excelMatch.excelBaseName}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="space-y-1">
                                                            <div class="font-medium text-gray-700">${match.invoiceProduct.descripcionNormalizada}</div>
                                                            <div class="text-xs text-green-600 bg-green-50 rounded-lg px-2 py-1 inline-block">
                                                                Base: ${match.excelMatch.invoiceBaseName}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-lg font-semibold text-gray-600">
                                                            ${formatCurrency(match.priceChange.oldPrice)}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-lg font-bold text-green-600 bg-green-50 px-3 py-1 rounded-lg">
                                                            ${formatCurrency(match.priceChange.newPrice)}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <span class="text-lg font-bold ${match.priceChange.difference >= 0 ? 'text-green-600' : 'text-red-600'} mr-2">
                                                                ${match.priceChange.difference >= 0 ? '+' : ''}${formatCurrency(match.priceChange.difference)}
                                                            </span>
                                                            <span class="text-2xl">
                                                                ${match.priceChange.difference >= 0 ? 'üìà' : 'üìâ'}
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-bold mr-3">
                                                                ${Math.round(match.excelMatch.score)}%
                                                            </div>
                                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                                <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full" style="width: ${match.excelMatch.score}%"></div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}

                            ${updateResults.unmatched.length > 0 ? `
                            <!-- Productos sin coincidencia con dise√±o llamativo -->
                            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                                <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6">
                                    <h3 class="text-2xl font-bold flex items-center">
                                        <span class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4">‚ö†Ô∏è</span>
                                        Productos sin Coincidencia (${updateResults.unmatched.length})
                                    </h3>
                                    <p class="text-orange-100 mt-2">
                                        Estos productos de la factura no se encontraron en el Excel y requieren revisi√≥n manual
                                    </p>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${updateResults.unmatched.map((product, index) => `
                                            <div class="bg-gradient-to-br from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-4 card-hover">
                                                <div class="flex items-start space-x-3">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                                                        ‚ö†Ô∏è
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="font-bold text-gray-900 mb-2">${product.descripcionNormalizada}</div>
                                                        <div class="text-sm text-gray-600 mb-3">
                                                            <span class="bg-gray-100 px-2 py-1 rounded-lg">
                                                                ${product.cantidad} ${product.unidad}
                                                            </span>
                                                        </div>
                                                        <div class="text-xl font-bold text-orange-600">
                                                            ${formatCurrency(product.valorUnitario)}
                                                        </div>
                                                        <div class="mt-2 text-xs text-orange-700 bg-orange-100 px-2 py-1 rounded-lg inline-block">
                                                            Requiere atenci√≥n manual
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                                        <div class="flex items-start space-x-3">
                                            <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center text-white font-bold">üí°</div>
                                            <div>
                                                <h4 class="font-semibold text-amber-800 mb-1">Recomendaciones:</h4>
                                                <ul class="text-sm text-amber-700 space-y-1">
                                                    <li>‚Ä¢ Verifica que los nombres en el Excel coincidan con los de la factura</li>
                                                    <li>‚Ä¢ Considera agregar estos productos al inventario si son nuevos</li>
                                                    <li>‚Ä¢ Revisa posibles variaciones en la nomenclatura</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('results').innerHTML = html;
            document.getElementById('results').style.display = 'block';
            document.getElementById('invoiceDetails').style.display = 'none';
            document.getElementById('updateSection').style.display = 'none';
            
            // Animar la aparici√≥n
            setTimeout(() => {
                document.getElementById('results').classList.add('visible');
                // Scroll suave a los resultados
                document.getElementById('results').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
        }
    </script>
</body>
</html>
